on: ['push']
# https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions#example-including-paths
#on:
#  push:
#    paths:
#      - 'scripts/install_conda.sh'

jobs:
  nanopore_pipeline:
    runs-on: ubuntu-latest
    container: continuumio/miniconda3
    steps:
      - uses: actions/checkout@v2
      - name: conda install
        run: |
          echo "::add-path::${PWD}"
          eval "$($(which conda) shell.bash hook)"
          conda create -q -y -n vsearch -c conda-forge -c bioconda vsearch
          conda activate vsearch
          ln -s $(which vsearch) ./usearch
          conda env create -q -n longread_umi -f environment.yml
          ln -s longread_umi.sh longread_umi
      - working-directory: test_data
        name: longread_umi nanopore_pipeline
        # -c is missing but required. Exiting.
        # -p is missing but required. Exiting.
        # . exists. Remove existing directory or rename desired output directory. (replace -o ./ with -o ./output)
        run: |
          set -x
          eval "$($(which conda) shell.bash hook)"
          conda activate longread_umi
          longread_umi nanopore_pipeline \
            -d test_reads.fq \
            -o ./output \
            -v 30 \
            -w rrna_operon \
            -p 1 \
            -q r941_min_high_g303 \
            -c 3 \
            -t 1

  qc_pipeline:
    runs-on: ubuntu-latest
    container: continuumio/miniconda3
    steps:
      - uses: actions/checkout@v2
      - name: conda install
        run: |
          echo "::add-path::${PWD}"
          eval "$($(which conda) shell.bash hook)"
          conda create -q -y -n vsearch -c conda-forge -c bioconda vsearch
          conda activate vsearch
          ln -s $(which vsearch) ./usearch
          conda env create -q -n longread_umi -f environment.yml
          conda activate longread_umi
          ln -s longread_umi.sh longread_umi
      - working-directory: test_data
        name: longread_umi qc_pipeline
        run: |
          set -x
          eval "$($(which conda) shell.bash hook)"
          conda activate longread_umi
          longread_umi qc_pipeline -d test_reads.fq -c consensus_raconx3_medakax1.fa -r zymo_curated -t 1
